---
title: Apollo planning
date: 2023-01-18 14:12:54
tags: ["planning"]
---

这篇博客解析百度阿波罗里面的轨迹规划
<!-- more -->

轨迹规划(Trajectories Planning)主要指考虑实际临时或者动态障碍物，考虑速度，动力学约束的情况下，尽量按照规划路径进行轨迹规划

轨迹规划的核心就是要解决车辆该怎么走的问题。轨迹规划的输入包括拓扑地图，障碍物及障碍物的预测轨迹，交通信号灯的状态，还有定位导航（因为要知道目的地是哪才能规划路径）、车辆状态等其他信息。而轨迹规划的输出就是一个轨迹，轨迹是一个时间到位置的函数，就是在特定的时刻车辆在特定的位置上。


无人驾驶车辆的位形和状态
$q = (x , y, \theta, \kappa)$


κ 即时转向曲率, 如果车辆的导向轮保持一定的角度，车辆会做圆周运动。这个圆周运动的半径的倒数就是即时转向曲率 κ， κ = 1/r ，**加入κ，有助于控制模块获得更准确的控制反馈，设计更为精细平稳的控制器**
运动状态：
车辆位形 + 与时间相关的变量（速度，加速度）
$s = (q, v, a)$

# 轨迹规划的定义：
计算函数 S，映射时间 t 到车辆状态 s ：
$S(t): t \rightarrow \mathbf s = (x, y, \theta, \kappa, v, a) , \forall t \in [0, t_{max}]$ 

满足条件
$\forall t\in [0, t_{max}]:$
  - 运动学约束： $\frac{dy}{dt} cos\theta - \frac{dx}{dt} sin\theta =0$
  - 碰撞约束
  - 车辆物理限制：最大加减速度、最大转向角，最大转向变化率等

# 轨迹规划的难点
1. 七个规划维度 $(x, y, \theta, \kappa, v, a) + t$ 
2. 车辆的运动学约束：$\frac{dy}{dt} cos\theta - \frac{dx}{dt} sin\theta =0$
3. 安全性，与障碍物保持适当距离
4. 舒适性要求，加加速度(jerk)最小化，到达时间最小化，等
     - 加加速度：加速度对时间的倒数，影响乘坐舒适度最重要的因素
     - 向心加速度：由于过弯引起的加速度 
5. 系统响应速度高：高频率运行，需要计算效率高的算法

轨迹规划是一个复杂的问题，首先，规划上加入了速度与时间的信息，增加了规划的维度。其次，由于车辆是非和谐系统，具有特殊的运动学约束条件。举个例子，车辆不能独立的横向移动，需要纵向移动的同时才能获得横向偏移。躲避障碍物，特别是高速动态障碍物，也是一个比较困难的问题。对于搭载乘客的无人驾驶车辆来说，非常重要的一个要求（在本人看来可能是最重要的）是舒适性，规划出的轨迹必须做到平滑，将影响乘客舒适度的因素，比如加速度，向心加速度等等，保持在能够容忍的范围。


# Apollo 中轨迹规划策略
## 降低规划维度：
- 路径与速度规划的分离，先确定路径，再确定沿路径的速度分配
- 路径规划，规划车辆行驶的几何形状， $s \rightarrow (x, y, \theta, \kappa) $
- 速度规划，规划车辆沿路径的速度分配， $t \rightarrow (s, v, a) $

## 障碍物避让策略
- 路径规划避让静态障碍物
- 速度规划避让动态障碍物

在 Apollo 平台中，为了解决规划问题，尤其是从降低计算的复杂性上，我们采取了对轨迹的路径与速度规划分离的方式。即先确定路径，也就是轨迹的几何形状，然后在已知路径的基础上，计算速度分配。使用这种策略，我们将一个高维度的轨迹规划问题，转换成了两个顺序计算的低维度规划问题：路径规划，借助中间变量路径的累计长度 s，先求解 s 映射到几何形状(x, y, θ, κ)的路径函数；速度规划，再求解时间 t，映射到中间变量 s,与 v，a 的速度函数

# 路径规划的目标

对路径的要求：
- 需要有足够的灵活性，能够避让复杂、拥挤的城市环境中的众多障碍物
- 需要做到路径平滑，路径的几何特性平顺变化是舒适性的前提
- 需要遵守车辆运动学的限制条件，比如路径的曲率、曲率变化率需要限制在符合车辆属性的范围之内
- 需要考虑到车辆的运动状态；低速、高速的运动状态下，路径的几何形状需要适当调整，保证横向运动的舒适性

# 路径规划方法
借助 Frenet 坐标系做运动分解

前提：曲率可导级别的光滑指引线
$(x, y, \theta, \kappa, v, a) \rightarrow \{(s,\dot{s},\ddot{s}),(l,l',l'')\}, \dot{s} = \frac{ds}{dt}, \ddot{s}=\frac{d^2s}{dt^2}, l'=\frac{dl}{ds}, l''=\frac{d^2l}{ds^2}$

在路径规划中，我们借助于弗莱纳坐标系，将当前车辆的运动状态$(x, y, \theta, \kappa, v, a)$ 做分解。使用弗莱纳坐标系的前提是具有一条光滑的指引线。一般情况下，我们可以将指引线理解为道路中心线，车辆在没有障碍物情况下的理想运动路径。我们这里的光滑的指引线是指指引线的几何属性可以到曲率级别的光滑（曲率可导）。指引线的光滑性至关重要，因为其直接决定了在弗莱纳坐标系下求得轨迹的平顺性。

在给定一条光滑指引线上，我们按照车辆位置，将其投影到指引线上，以投射点为基础，将地图坐标系下当前车辆的运动状态$(x, y, \theta, \kappa, v, a)$进行分解，获得沿着指引线方向的位置，速度，加速度，以及相对于指引线运动的位置， “速度”， “加速度”。这里打引号的原因是横向的“速度”、“加速度”并非通常意义上位移对时间的一阶/二阶导数，而是横向位移对纵向位移的一阶/二阶导数，它们描述了几何形状的变化趋势




## Frenet 坐标系下作轨迹规划的优点
- 运动轨迹降维度
- 更好理解场景，不受道路几何形状的影响

在弗莱纳坐标系下做运动规划的好处在于借助于指引线做运动分解，我们将高维度的规划问题，转换成了多个低维度的规划问题，极大的降低了规划的难度。另外一个好处在于方便理解场景，无论道路在地图坐标系下的形状与否，我们都能够很好的理解道路上物体的运动关系。相较直接使用地图坐标系下的坐标做分析，使用弗莱纳坐标，**能够直观的体现道路上不同物体的运动关系**


## 分段加加速度优化算法流程：
1. 在 frenet 坐标系下的函数 $l(s)$表达了以指引线为参考，相对于指引线的几何形状；通过转化到地图坐标系下，就表达了在地图坐标系的路径；所以本质上在 frenet坐标系下路径规划问题就是一个计算函数 $l(s)$的过程。这里使用的是**分段加加速度优化**(Piecewise Jerk Path Optimization Algorithm)算法，首先将环境中的静态障碍物映射到 frenet 坐标系中
![](/source/img/frenet1.jpeg)

2. 将指引线(s轴)方向根据同等的间隔$\Delta s$离散化，根据障碍物的几何信息、道路的边界信息，计算每一个离散点$s$的可行区域 $(l^i_{min} ,l^i_{max} )$，这里将无人车简化成了一个点，为了避免碰撞，在计算可行驶区域时可以留出适当的缓冲空间
![](/source/img/frenet2.png)

3. 选择优化的变量。对于每一个离散点 $i$ ，将该点的横向偏移 $l_i$，横向偏移相对于 s 的一阶导数和二阶导数 $l_i'$和二阶导数 $l_i''$ 作为优化变量。$l_i'$ 和$l_i''$ 可以近似理解为横向运动中的“速度”与“加速度”。他们的大小决定了车辆靠近与偏离指引线的趋势。假设每两个离散点之前，有一个常三阶导数项$l_{i\rightarrow i+1}'''$连接着相邻的离散点，这个“常”三阶导数项可以由相邻的二阶导数通过差分方式计算得到。在优化的迭代过程中，$l_{i\rightarrow i+1}'''$会随着相邻点$l_i''$与$l_{i+1}''$的变化而变化，但$l_{i\rightarrow i+1}'''$在两个离散点直接会保持不变。这也是算法的得名，分段加加速度算法
![](/source/img/frenet3.png)

4. 设置优化目标。对于路径来讲，在没有环境因素的影响下，我们希望它尽可能的贴近指引线。对于一阶、二阶与三阶导数，我们希望它们尽可能的小，这样可以控制横向运动的向心加速度，保证路径的舒适性，即最小化 $l_i',l_i'',l_{i\rightarrow i+1}'''$
![](/source/img/frenet4.png)


## 分段加加速度优化算法完整描述：
### 输入
- 光滑的道路指引线，用于在 frenet 坐标系下的运动分解
- 当前的车辆运动状态$(x,y,\theta,\kappa,v,a)$。车辆运动状态会依照光滑指引线进行分解
- 环境中的静态障碍物和道路边界信息，投影到指引线上
- 车辆自身属性，包括几何尺寸，轴距，最大转向角及速率等，用于计算优化过程中合理的变量限制条件

### 输出
连续曲率的平滑行驶路径

## 优化变量
![](/source/img/frenet5.png)

### 约束条件
- 障碍物躲避：$l_i\in(l_{min}^i, l_{max}^i)$
- 根据车辆的运动学模型和当前的移动速度，估计 $l',l'',l'''$的取值范围
- 路径连续性：
  $$
  \begin{cases}
    l'_{i+1}=l_i'+l_i''*\Delta s + \frac{1}{2}l'''_{i\rightarrow i+1} * \Delta s^2 \\
    l_{i+1} = l_i +l'_i * \Delta s + \frac{1}{2}l''* \Delta s^2  + \frac{1}{6}l'''_{i\rightarrow i+1} * \Delta s^3\\
  \end{cases}
  $$
算法的变量为每一个离散点的横向位移，横向位移对指引线纵向长度 s 的一阶、二阶导数，对于一个有 n 个输入点的问题，优化变量有 3*n 个。一个非常关键的约束条件是路径的连续性，这里假设了相邻两点之间有一个常三阶导数量$l_{i\rightarrow i+1}'''$来连接，我们需要确定经过这个常三阶导数量$l_{i\rightarrow i+1}'''$相邻两个点的$l,l',l''$的数值能够吻合

## 优化目标函数

$f = w_l \sum _{i=0}^{n-1} l_i^2 + w_l' \sum _{i=0}^{n-1} l_i'^2 + w_l'' \sum _{i=0}^{n-1} l_i''^2 +w_l''' \sum _{i=0}^{n-2} l_{i\rightarrow i+1}'''^2 $

## 总结
算法的优化目标是减小横向位移的零阶、一阶、二阶和三阶导数，使路径尽可能贴近指引线的同时保证舒适性。同时可以根据需求选择性的加入与边界距离的优化目标，使车辆与障碍物保持适当距离。分段加加速度算法由于其大密度分段的特性，使得能够表达的路径具有很高的灵活性，能够解决城市道路中的路径规划问题；并且，由于是以加加速度级别的控制变量来改变路径的形状，能够做到曲率级别的连续性，保证了路径的平滑舒适。
优点：
- 纵向大密度的离散分割，使得路径具有很大灵活性
- 生成的路径能够做到曲率级别的连续，保证路径的平滑性


# 速度规划的目标
对速度规划的要求：
- 灵活性：能够避让复杂、拥挤的城市环境中的众多动态障碍物
- 速度分配平滑：速度、加速度的平顺变化是舒适性的前提；并且需要考虑给定路径的几何属性，在曲率不同的地图适当调整速度分配，提高过弯舒适性
- 遵守车辆运动学限制条件：如最大速度、加速度、加加速度等，规划出的轨迹车辆可以执行
- 遵守交通法规的限制，在限速范围内规划
- 需要完成达到指定位置或速度的任务，并且在保证舒适度的前提下，完成时间尽可能的短

# 速度规划的策略
在Apollo中采用了结合**启发式速度规划和分段加加速度算法**相结合的方式来解决速度规划问题。

启发式速度规划提供考虑了动静态障碍物、路径几何信息、道路信息、舒适度、目标速度和地点多种因素综合下的速度规划**粗略**估计

分段加加速度算法对启发式速度规划提供的粗略估计进行平滑，输出安全舒适的速度分配

## 启发式速度规划

### 路径-时间障碍物图
在启发式速度规划中采用了一个非常好的分析工具，路径-时间障碍物图（Path-Time Obstacle graph）。路径-时间障碍物图非常适合在确定了路径的情况下，考虑动静态障碍物的规避问题。这个分析工具的核心思想就是将考虑了本车和周围障碍物几何形状和预测轨迹的情况下，将障碍物的轨迹投影到已经确定的本车路径上。障碍物所代表的含义是在**何时(t)与何地(s)**本车会与障碍物发生碰撞

### 搜索方式
路径-时间障碍物图根据时间轴t和沿路径的累计距离s离散化，形成等距离、等时间的网格状图，然后根据需求，将各种因素（限速、碰撞、路径几何形状、舒适度等）使用不同的权重，建模成一个单一熟知的代价函数，每一个网格节点会赋予一个cost，相邻网格之间的边也视为代价的一部分，用来建模加速度。整个过程可以看出是一个图搜索的过程，搜索出一个代价最优的路径。搜索的结果就是一系列的路径距离与时间的序列，代表车辆何时(t)到达何地(s)

## 分段加加速度平滑算法
启发式速度规划的粗略结果只能提供位置，缺乏控制模块所需要的更高维信息，不适合控制模块直接使用，产生的结果需要进一步的平滑才能满足舒适度要求。这里进一步做平滑处理的就是分段常加加速度算法，其主要思想类似于前面的路径优化算法，在给定趋近启发式速度规划结果的情况下，调整启发式速度规划，提高速度分配的平滑性
- 输入：$(t_0,s_0^h),(t_1,s_1^h),...,(t_{n-1},s_{n-1}^h)$
- 输出：加速度级别连续变化的平滑函数 $s(t)$
- $s(t)$离散化：以时间 t 为参数，$\Delta t$间隔离散化$s(t)$
- 变量：每个离散点的位置 $s_i$，速度$\dot{s_i}(\frac{ds}{dt})$，加速度$\ddot{s_i}(\frac{d^2s}{dt^2})$
- 假设：相邻两点之间，使用常加加速度 $\dot{}\ddot{s}_{i\rightarrow i+1} = \frac{\ddot{s}_{i+1}-\ddot{s_i}}{\Delta t}$

变量关系图为：
![](/source/img/frenet7.png)

## 优化目标函数
优化目标：
- 位置变量 $s_i$贴近对应的启发式搜索位置 $s_i^h$
- 惩罚加速度 $\ddot{s}_i$和加加速度$\dot{}\ddot{s}_{i\rightarrow i+1}$
因此目标函数为：
$f = w_h * \sum _{i=0} ^{n-1}(s_i-s_i^h)^2 + w_{\ddot{s}} *\sum _{i=0}^{n-1}\ddot{s_i}^2 + w_{\dot{}\ddot{s}} *\sum _{i=0}^{n-2}\dot{}\ddot{s}^2_{i\rightarrow i+1} * \Delta t^3$

## 约束条件
- 速度分配的连续性
$$
  \begin{cases}
    \dot{s}_{i+1}=\dot{s}_i+\ddot{s}_i*\Delta t + \frac{1}{2}\dot{}\ddot{s}_{i\rightarrow i+1} * \Delta t^2 \\
    \dot{s}_{i+1} = s_i +\dot{s}_i * \Delta t + \frac{1}{2}\ddot{s}* \Delta t^2  + \frac{1}{6}\dot{}\ddot{s}_{i\rightarrow i+1} * \Delta t^3\\
  \end{cases}
$$
- 加速度与加加速度的限制：
$$
  \begin{cases}
    \ddot{s}_i \in [\ddot{s}_{min},\ddot{s}_{max}] \\
    \dot{}\ddot{s}_{i\rightarrow i+1} \in [\dot{}\ddot{s}_{min},\dot{}\ddot{s}_{max}] \\
  \end{cases}
$$

在优化函数的设置上，与前面相似的地方是惩罚加速度与加加速度以获得舒适的乘坐体验。不同的一个优化目标是希望位置变量与启发式规划所得到的位置信息尽可能贴近。启发式规划所得到的位置信息蕴含了根据**路径几何形状、道路限速**等等所做出的计算，这些计算绑定在相应的位置上，所以优化之后的轨迹需要贴近于相应的启发式结果才能体现启发式规划所做的选择

## 算法优点与问题
- 启发式速度规划
  - 近似解决了位置s与时间t相互耦合影响的问题
  - 离散粒度影响了搜索质量，不能精确反映车辆的动态变化，也非最优

- 分段加加速度平滑算法
  平滑时单纯贴近启发式速度规划，速度规划并非最优

## 为什么分成启发式的速度规划与分段加加速度算法结合的形式？
主要的问题在于在速度规划的时候，我们进行离散的维度、时间，也是我们优化目标的一部分。位置与时间同为优化变量，与位置相关的限制条件, 比如路径曲率，道路限速信息等等，会影响到达位置的时间；而时间的变化又会引起优化速度的变化，进而导致位置发生变化。这就导致了一种变量间耦合变化的情况。启发式速度规划使用粗略的方法，近似解决了位置s决定的限制条件与时间t相互耦合的问题，使时间成为了常量。

<!-- ## <font color=red>障碍物</font> -->

<!-- $\chi$
$\theta$


$\frac{abc}{xyz}$ -->








<!-- 此篇博客介绍 planning -->


<!-- planning 通过基于frenet坐标系的指引线来降低计算的维度，使其变成了一个基于frenet坐标系下的3维约束的最优化问题
通常有两种方法：
1. 直接进行三维优化
2. 路径和速度解耦的方法

直接进行三维优化的方法是试图在SLT内使用轨迹采样或网格搜索来寻找最佳轨迹。这些方法受到其搜索复杂度的限制，随着空间和时间搜索分辨率的提高，搜索复杂度也在增加，为了满足实时性的需求，
通常需要增加网格大小或者采样分辨率，因此生成的轨迹是次优的

路径-速度解耦方法则分别对路径和速度进行优化。 路径优化通常考虑静态障碍物，然后根据生成的路径生成速度曲线， 随着动态障碍物的出现，路径-速度解耦法有可能不是最佳选择，但是由于路径和速度是解耦的，这种方法在路径和速度的优化方面实现了更大的灵活性。


EM规划器迭代的优化路径和速度， 在路径优化器中，上一周期的速度曲线被用来估计与此周期低速动态障碍物的相互作用。然后生成的路径被发送到速度优化器，以评估一个最佳速度曲线。对于高速动态障碍物，EM规划器出于安全考虑，更倾向于采取变道而不是nudge的方式。因此EM规划器的迭代策略能够去处理路径-速度解耦的框架下的动态障碍物


EM planner中，在提供平滑轨迹之前会先做决策，决策的作用是使车辆在路上的意图明确，减少寻找最佳轨迹的搜索空间。决策通常可以分为基于规则和基于模型的决策。

首先，用一个粗略可行的轨迹来描述自车的移动意图，用这个轨迹也表示了自车与障碍物之间的相互作用。其次，规划器还将根据轨迹为平滑样条曲线参数生成一个凸的可行空间。
一个基于凸优化的平滑样条求解器可以用来根据决策生成平滑的路径和速度曲线。这保证了一个可行的、平稳的解决方案

QP样条路径通过求解器求解优化线性约束下的目标函数得到

其中QP的目标函数是 平滑损失函数与指导线损失函数，指导线就是DP阶段提供的路径
QP路径中的约束包括边界约束和动态可行性 -->

* 初始化open_set和close_set；
* 将起点加入open_set中，并设置优先级为0（优先级最高）；
* 如果open_set不为空，则从open_set中选取优先级最高的节点n：
    * 如果节点n为终点，则：
        * 从终点开始逐步追踪parent节点，一直达到起点；
        * 返回找到的结果路径，算法结束；
    * 如果节点n不是终点，则：
        * 将节点n从open_set中删除，并加入close_set中；
        * 遍历节点n所有的邻近节点：
            * 如果邻近节点m在close_set中，则：
                * 跳过，选取下一个邻近节点
            * 如果邻近节点m也不在open_set中，则：
                * 设置节点m的parent为节点n
                * 计算节点m的优先级
                * 将节点m加入open_set中